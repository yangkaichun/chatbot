// --- !!! MODIFIED handleUserInput Function in chatbot_v5.html !!! ---
async function handleUserInput(text) { // Add async keyword
    if (!text) return;

    const lastUserMessage = chatContainer.querySelector('.user-message:last-child');
    if (!lastUserMessage || lastUserMessage.textContent !== text) {
         addUserMessage(text);
    }

    userInput.value = '';
    adjustTextareaHeight();
    sendButton.style.display = 'none';

    // --- Call Backend API ---
    // IMPORTANT: Replace with the ACTUAL URL of your deployed backend service
    const BACKEND_URL = 'https://your-deployed-backend-url.example.com/api/recommend'; // <--- CHANGE THIS

    // Add a temporary "Thinking..." message for the bot
    const thinkingMsg = addBotMessage("AI 正在思考中..."); // Store the element if you want to update/remove it later

    try {
        const response = await fetch(BACKEND_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ symptoms: text }), // Send symptoms in request body
        });

        // Remove the "Thinking..." message (optional)
         if(thinkingMsg && thinkingMsg.parentNode) { // Check if element exists and is in DOM
             thinkingMsg.remove();
         }


        if (!response.ok) {
            // Try to get error details from backend response body
            let errorData = { error: `請求失敗，狀態碼: ${response.status}`};
            try {
                errorData = await response.json();
            } catch (e) { /* Ignore if response is not JSON */ }
             console.error("Backend request failed:", response.status, errorData);
            addBotMessage(`抱歉，與 AI 伺服器溝通時發生錯誤 (<span class="math-inline">\{response\.status\}\)。</span>{errorData.error ? `詳情: ${errorData.error}` : ''}`);
            return; // Stop processing on error
        }

        const data = await response.json();

        // Display the recommendation received from the backend
        if (data.recommendation) {
             addBotMessage(data.recommendation); // Display the response crafted by the backend
        } else {
             addBotMessage("抱歉，AI 未能提供有效的建議。");
        }

    } catch (error) {
         // Remove the "Thinking..." message on network error too (optional)
         if(thinkingMsg && thinkingMsg.parentNode) {
             thinkingMsg.remove();
         }

        console.error('Error calling backend API:', error);
        addBotMessage("抱歉，無法連接到 AI 伺服器。請檢查網路連線或稍後再試。");
    }
}

 // Make addBotMessage return the element so we can remove "Thinking..."
 function addBotMessage(text) {
     const messageDiv = document.createElement('div');
     messageDiv.classList.add('message', 'bot-message');
     messageDiv.textContent = text;
     chatContainer.appendChild(messageDiv);
     chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
     return messageDiv; // Return the created element
 }
